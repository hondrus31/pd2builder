"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js");import e from"./Builder.js";import t from"./Util.js";const n=new Map([["en-us","English (American)"],["ru-ru","Russian"],["zh-cn","Simplified Chinese"]]);let i="en-us";const o=new e(window.innerWidth<1003);window.addEventListener("resize",()=>{const e=new URL(window.location.href);!o.mobile&&window.innerWidth<1003?(e.pathname+="mobile.html",window.location.replace(e)):o.mobile&&window.innerWidth>=1003&&(e.pathname=e.pathname.replace("mobile.html",""),window.location.replace(e))}),document.onreadystatechange=async()=>{let s,a;{const e=document.getElementById("langDrop"),l=new URLSearchParams(window.location.search);for(const[t,i]of n){const n=new Option(i,t);e.appendChild(n)}const r=[...n.keys()];if(l.has("lang")&&n.has(l.get("lang"))){const e=l.get("lang");a=e,sessionStorage.setItem("lang",e)}else sessionStorage.getItem("lang")?a=sessionStorage.getItem("lang"):(n.has(navigator.language.toLowerCase())?i=navigator.language:r.some(e=>e.startsWith(navigator.language.split("-")[0]))?i=r.find(e=>e.startsWith(navigator.language.split("-")[0])):navigator.languages&&(i=navigator.languages.find(e=>n.has(e.toLowerCase()))||r.find(e=>navigator.languages.some(t=>e.startsWith(t.split("-")[0])))||i),a=i=i.toLowerCase());s=fetch(`./lang/${a}.json`).then(e=>e.json()),e.value=a,e.addEventListener("change",async e=>{const n=e.target.value;sessionStorage.setItem("lang",n),o.loadLanguage(await fetch(`./lang/${n}.json`).then(e=>e.json()),n),window.history.pushState(t.makeState(o.lang.used,o.exp),`language changed to ${n}`)})}if(o.mobile){document.onclick=e=>{e.target.closest("#description_card.active")||o.gui.DescriptionCard_Show(!1),e.target.closest("#sk_tree_buttons button, sk_tree_button_group")||o.gui.Tree_ShowSelection(!1)},document.querySelector("#description_card > a").addEventListener("click",()=>o.gui.DescriptionCard_Show(!1));{const e=document.getElementById("description_card");let t=0,n=0,i=null;e.addEventListener("touchstart",e=>{if(null!==i)return;const t=e.touches.item(0);i=t.identifier,n=t.clientX}),e.addEventListener("touchmove",e=>{if(e.preventDefault(),null!==i)for(const i of e.changedTouches)return(t=-(i.clientX-n))>0&&(t=0),void o.gui.DescriptionCard_Analog(t)}),e.addEventListener("touchend",n=>{if(null!==i){for(const e of n.targetTouches)if(e.identifier===i)return;n.touches.length>0?i=n.touches.item(0).identifier:(i=null,t<=e.clientWidth/-3?o.gui.DescriptionCard_Show(!1):o.gui.DescriptionCard_Show())}}),e.addEventListener("touchcancel",()=>{i=null,o.gui.DescriptionCard_Show()})}document.querySelector("#sk_tree_buttons button").addEventListener("click",()=>o.gui.Tree_ShowSelection()),document.getElementById("sk_prev_tree").addEventListener("click",e=>{if(e.target.classList.contains("hidden"))return;const t=[...document.querySelectorAll(".sk_tree_button_group > div")],n=t.findIndex(e=>e.classList.contains("sk_tree_button_active"));t[n-1].click()}),document.getElementById("sk_next_tree").addEventListener("click",e=>{if(e.target.classList.contains("hidden"))return;const t=[...document.querySelectorAll(".sk_tree_button_group > div")],n=t.findIndex(e=>e.classList.contains("sk_tree_button_active"));t[n+1].click()})}document.querySelectorAll("#tab_page_buttons button").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("id").replace("_button","_page");o.gui.Tab_IsOn(t)||("tab_io_page"===t&&(document.getElementById("io_share_link").value=o.io.GetEncodedBuild()),o.gui.HandleRequirements(e.getAttribute("id").replace(/tab_|_button/g,"")),o.gui.Tab_ChangeTo(t))})});for(const t of e.TREES)document.getElementById(`sk_${t}_button`).addEventListener("click",e=>{o.gui.Tree_ChangeTo(e.target.id.replace("button","container")),o.mobile&&o.gui.Tree_ShowSelection(!1)});for(const e of document.getElementsByClassName("mousewheel_scrollable"))e.addEventListener("wheel",e=>{e.deltaY<0?o.gui.Tree_ChangeByScrolling(!1):o.gui.Tree_ChangeByScrolling(!0),e.preventDefault()});for(const e of document.getElementsByClassName("sk_subtree"))e.addEventListener("mouseenter",()=>{o.gui.Subtree_HoveringHighlightOn(e)}),e.addEventListener("mouseleave",()=>{o.gui.Subtree_HoveringHighlightOff()});for(const e of document.getElementsByClassName("sk_icon")){let n,i=!1,s=!1;e.addEventListener("click",i=>{if(clearTimeout(n),s)return s=!1,void i.preventDefault();const a=e.firstElementChild.id;if(e.classList.contains("sk_locked")||e.classList.contains("sk_selected_aced"))o.gui.Skill_AnimateInvalid(e);else if(o.sys.Skill_Add(a)){o.gui.Skill_Add(e),"jack_of_all_trades"===a&&e.classList.contains("sk_selected_aced")&&o.gui.HandleJoat();const n=o.dbs.get("skills").get(a);o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Subtree_MoveBackground(n.subtree,o.exp.subtrees[n.subtree].points),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(o.lang.used,o.exp),`added skill ${a}`,o.io.GetEncodedBuild())}else o.gui.Skill_AnimateInvalid(e)}),e.addEventListener("contextmenu",n=>{n.preventDefault();const i=e.firstElementChild.id;if(o.sys.Skill_Remove(i)){o.gui.Skill_Remove(e),"jack_of_all_trades"!==i||e.classList.contains("sk_selected_aced")||o.gui.HandleJoat();const s=o.dbs.get("skills").get(i);o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Subtree_MoveBackground(s.subtree,o.exp.subtrees[s.subtree].points),o.gui.HandleUnlocks({type:"skill",id:i,unlocks:s.unlocks}),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(o.lang.used,o.exp),`removed skill ${i}`,o.io.GetEncodedBuild())}else o.gui.Skill_AnimateInvalid(e)}),o.mobile||e.addEventListener("mouseenter",()=>{const t=e.firstElementChild.id;document.getElementsByClassName("sk_description")[0].dataset.skill!==t&&o.gui.Skill_DisplayDescription(t)}),e.addEventListener("touchend",t=>{if(t.preventDefault(),clearTimeout(n),s)s=!1;else{if(i){const t=o.exp.skills.get(e.firstElementChild.id);return t?Array.from(Array(t.state)).forEach(()=>e.dispatchEvent(new MouseEvent("contextmenu",{detail:-1}))):[0,1].forEach(()=>e.click()),void(i=!1)}i=!0,setTimeout(()=>{i&&(i=!1,e.dispatchEvent(new MouseEvent("click",{detail:-1})))},250)}},!1);const a=t=>{t instanceof MouseEvent&&0!=t.button||(n=setTimeout(()=>{t.preventDefault(),s=!0;const n=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Skill_DisplayDescription(n)},750))};o.mobile&&e.addEventListener("mousedown",a),e.addEventListener("touchstart",a)}for(const e of document.getElementsByClassName("pk_deck")){let n,i=!1;e.addEventListener("click",s=>{if(clearTimeout(n),i)return void(i=!1);const a=e.id,l=o.exp.perkDeck;o.exp.perkDeck!==a&&(o.exp.perkDeck=a,o.gui.PerkDeck_Select(e),l&&o.gui.HandleUnlocks({type:"perkDeck",id:l,unlocks:o.dbs.get("perk_decks").get(l).unlocks}),s.isTrusted&&window.history.pushState(t.makeState(o.lang.used,o.exp),`used perk ${a}`,o.io.GetEncodedBuild()))}),o.mobile||e.addEventListener("mouseenter",()=>{const t=e.id;document.getElementsByClassName("pk_description")[0].dataset.perkdeck!==t&&o.gui.PerkDeck_DisplayDescription(t)}),e.addEventListener("touchend",e=>{if(clearTimeout(n),i)return e.preventDefault(),void(i=!1)});const s=t=>{t instanceof MouseEvent&&0!=t.button||(n=setTimeout(()=>{t.preventDefault(),i=!0;let n=e.firstElementChild.id;o.mobile&&(o.gui.DescriptionCard_Show(),n=e.id),o.gui.PerkDeck_DisplayDescription(n)},750))};o.mobile&&e.addEventListener("mousedown",s),e.addEventListener("touchstart",s)}o.mobile?document.querySelectorAll(".pk_deck_cards > div").forEach(e=>{let t,n=!1;const i=i=>{i instanceof MouseEvent&&0!=i.button||(t=setTimeout(()=>{i.preventDefault(),i.stopPropagation(),n=!0,o.gui.DescriptionCard_Show(),o.gui.PerkCard_DisplayDescription(e)},750))},s=e=>{if(!(e instanceof MouseEvent&&0!=e.button))return clearTimeout(t),n?(e.preventDefault(),e.stopPropagation(),void(n=!1)):void 0};e.addEventListener("mousedown",i),e.addEventListener("touchstart",i),e.addEventListener("mouseup",s),e.addEventListener("touchend",s)}):document.querySelectorAll(".pk_deck_cards > div").forEach(e=>{e.addEventListener("mouseenter",()=>{o.gui.PerkCard_HoveringHighlightOn(e),o.gui.PerkCard_DisplayDescription(e)}),e.addEventListener("mouseleave",()=>{o.gui.PerkCard_HoveringHighlightOff()})});for(const e of document.getElementsByClassName("arm_icon")){let n,i=!1;e.addEventListener("click",s=>{if(clearTimeout(n),i)return void(i=!1);const a=e.firstElementChild.id;o.exp.armor===a||e.classList.contains("arm_locked")||(o.exp.armor=a,o.stats.setBaseStats(o.dbs.get("armors").get(a).stats),o.gui.Armor_Select(e),o.gui.Armor_DisplayDescriptionCard(a),s.isTrusted&&window.history.pushState(t.makeState(o.lang.used,o.exp),`used armor ${a}`,o.io.GetEncodedBuild()))}),o.mobile||e.addEventListener("mouseenter",()=>{o.gui.Armor_DisplayDescriptionCard(e.firstElementChild.id)}),e.addEventListener("touchend",e=>{if(clearTimeout(n),i)return e.preventDefault(),void(i=!1)});const s=t=>{t instanceof MouseEvent&&0!=t.button||(n=setTimeout(()=>{t.preventDefault(),i=!0;const n=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Armor_DisplayDescriptionCard(n)},750))};o.mobile&&e.addEventListener("mousedown",s),e.addEventListener("touchstart",s)}for(const e of document.getElementsByClassName("th_icon")){let n,i=!1;e.addEventListener("click",s=>{if(clearTimeout(n),i)return void(i=!1);const a=e.firstElementChild.id;o.exp.throwable===a||e.classList.contains("th_locked")||(o.exp.throwable=a,o.gui.Throwable_Select(e),s.isTrusted&&window.history.pushState(t.makeState(o.lang.used,o.exp),`used throwable ${a}`,o.io.GetEncodedBuild()))}),o.mobile||e.addEventListener("mouseenter",()=>o.gui.Throwable_DisplayDescriptionCard(e.firstElementChild.id)),e.addEventListener("touchend",e=>{if(clearTimeout(n),i)return e.preventDefault(),void(i=!1)});const s=t=>{t instanceof MouseEvent&&0!=t.button||(n=setTimeout(()=>{t.preventDefault(),i=!0;const n=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Throwable_DisplayDescriptionCard(n)},750))};o.mobile&&e.addEventListener("mousedown",s),e.addEventListener("touchstart",s)}for(const e of document.getElementsByClassName("dp_icon")){let n,i=!1,s=!1;e.addEventListener("click",i=>{if(clearTimeout(n),s)return void(s=!1);const a=e.firstElementChild.id;o.exp.deployable===a||e.classList.contains("dp_locked")||(o.exp.deployableSecondary===a&&(o.exp.deployableSecondary=null,o.gui.DeployableSecondary_Unselect()),o.exp.deployable=a,o.gui.Deployable_Select(e),(i.isTrusted||-1==i.detail)&&window.history.pushState(t.makeState(o.lang.used,o.exp),`used perk ${a}`,o.io.GetEncodedBuild()))}),e.addEventListener("contextmenu",n=>{n.preventDefault();const i=o.exp.skills.get("jack_of_all_trades"),s=e.firstElementChild.id;i&&2==i.state&&o.exp.deployable!==s?(o.exp.deployableSecondary=s,o.gui.Deployable_SelectSecondary(e),(n.isTrusted||-1==n.detail)&&window.history.pushState(t.makeState(o.lang.used,o.exp),`used perk ${s}`,o.io.GetEncodedBuild())):e.dispatchEvent(new MouseEvent("click",{detail:-1}))}),o.mobile||e.addEventListener("mouseenter",()=>o.gui.Deployable_DisplayDescriptionCard(e.firstElementChild.id)),e.addEventListener("touchend",t=>{if(t.preventDefault(),clearTimeout(n),s)s=!1;else{if(i)return i=!1,void e.dispatchEvent(new MouseEvent("contextmenu",{detail:-1}));i=!0,setTimeout(()=>{i&&(i=!1,e.dispatchEvent(new MouseEvent("click",{detail:-1})))},250)}},!1);const a=t=>{t instanceof MouseEvent&&0!=t.button||(n=setTimeout(()=>{t.preventDefault(),s=!0;const n=e.firstElementChild.id;o.mobile&&o.gui.DescriptionCard_Show(),o.gui.Deployable_DisplayDescriptionCard(n)},750))};o.mobile&&e.addEventListener("mousedown",a),e.addEventListener("touchstart",a)}document.getElementById("io_copy_btn").addEventListener("click",()=>{const e=document.getElementById("io_share_link");e.select(),document.execCommand("copy"),e.blur(),o.gui.IO_CopyLinkFlash()});{const e=document.getElementById("io_share_button");"share"in navigator?e.addEventListener("click",()=>navigator.share({title:"PD2Builder",text:"Check out this build!",url:o.io.GetEncodedBuild()})):e.style.display="none"}window.onpopstate=async e=>{if(e.state)for(const[t,n]of Object.entries(e.state))switch(t){case"lang":sessionStorage.setItem("lang",n),document.getElementById("langDrop").value=n,o.loadLanguage(await fetch(`./lang/${n}.json`).then(e=>e.json()),n);break;case"skills":for(const[e,t]of[...o.exp.skills].reverse()){const i=n[e],o=document.getElementById(e).parentElement;if(i)t.state>i.state?o.dispatchEvent(new MouseEvent("contextmenu")):t.state<i.state&&o.click();else for(let e=t.state;e>0;e--)o.dispatchEvent(new MouseEvent("contextmenu"));delete n[e]}for(const[e,t]of Object.entries(n))for(let n=0;n<t.state;n++)document.getElementById(e).parentElement.click();break;case"perkDeck":if(!n){o.exp.perkDeck=null,o.gui.PerkDeck_Unselect(),o.gui.PerkCard_HoveringHighlightOff();break}document.getElementById(n).click();break;case"armor":if(!n){o.exp.armor=null,o.gui.Armor_Unselect();break}case"throwable":if(!n){o.exp.throwable=null,o.gui.Throwable_Unselect();break}case"deployable":if(!n){o.exp.deployable=null;const e=document.querySelector(".dp_primary, .dp_selected");e&&o.gui.Deployable_Unselect(e);break}document.getElementById(n).parentElement.click();break;case"deployableSecondary":if(!n){o.exp.deployableSecondary=null;const e=document.querySelector(".dp_secondary");e&&o.gui.Deployable_Unselect(e);break}document.getElementById(n).parentElement.dispatchEvent(new MouseEvent("contextmenu"))}},await o.fetchPromises,o.loadLanguage(await s,a),o.gui.Tab_ChangeTo("tab_skills_page"),o.gui.Skill_UpdatePointsRemaining(o.exp.skills.points),o.gui.Tree_ChangeTo("sk_mastermind_container"),o.io.HasToLoadBuild()&&o.io.LoadBuildFromIterable(new URLSearchParams(window.location.search)),window.history.replaceState(t.makeState(a,o.exp),"PD2 Builder"),o.gui.LoadingSpinner_Display(!1)},window.builder=o;
